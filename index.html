<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookVerse - Global Book Search Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #374151;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
        }
        
        body { 
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .bg-white {
            background-color: var(--bg-secondary) !important;
        }
        
        .text-gray-900 {
            color: var(--text-primary) !important;
        }
        
        .text-gray-600 {
            color: var(--text-secondary) !important;
        }
        
        .border-gray-200 {
            border-color: var(--border-color) !important;
        }
        
        .search-focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .catalog-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .library-marker {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .library-marker:hover circle {
            r: 12;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .availability-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Dark mode specific overrides */
        .dark .shadow-sm {
            box-shadow: var(--shadow);
        }
        
        .dark input {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .dark select {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .dark .bg-gray-50 {
            background-color: #374151 !important;
        }
        
        .dark .bg-gray-100 {
            background-color: #4b5563 !important;
        }
        
        .dark .text-gray-700 {
            color: #d1d5db !important;
        }

        .dark .text-gray-500 {
            color: #9ca3af !important;
        }

        /* Broad dark-mode overrides to ensure consistent backgrounds, borders and card colors */
        .dark header,
        .dark .bg-white,
        .dark .rounded-xl,
        .dark .rounded-lg,
        .dark .catalog-item,
        .dark .shadow-sm,
        .dark .p-6,
        .dark .p-4,
        .dark .p-3,
        .dark .max-w-3xl,
        .dark .max-w-4xl,
        .dark .max-w-7xl {
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
            box-shadow: var(--shadow) !important;
        }

        /* Modal/content cards */
        .dark #bookModal .bg-white,
        .dark #bookModalContent,
        .dark .modal-content {
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
        }

        /* Breadcrumb and small panels */
        .dark .bg-blue-50,
        .dark .bg-gray-50,
        .dark .bg-gray-100,
        .dark .bg-gradient-to-br {
            background-color: var(--bg-secondary) !important;
        }

        /* Inputs and selects */
        .dark input,
        .dark select,
        .dark textarea {
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        /* Small muted text */
        .dark .text-gray-600 { color: var(--text-secondary) !important; }

        /* Leaflet popups & map controls - darker background */
        .dark .leaflet-popup-content-wrapper,
        .dark .leaflet-control {
            background: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        .dark .text-gray-500 {
            color: #9ca3af !important;
        }
        
        .dark .hover\:bg-gray-100:hover {
            background-color: #374151 !important;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Leaflet marker styles */
        .custom-marker-digital {
            background: transparent !important;
            border: none !important;
        }

        .custom-marker-book {
            background: transparent !important;
            border: none !important;
        }

        .marker-ia {
            background: #6366f1;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            opacity: 0.6;
        }

        .marker-ol {
            background: #f59e42;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            font-size: 10px;
            opacity: 0.6;
        }

        .marker-book {
            background: #10b981;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            text-align: center;
            line-height: 16px;
            font-size: 10px;
        }

        /* Cover placeholder and lazy image styles */
        .cover-placeholder {
            width: 56px; /* approx w-14 */
            height: 72px; /* approx h-18 */
            background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 100%);
            display:flex; align-items:center; justify-content:center;
            color:#6b7280; font-size:20px;
        }
        .cover-thumb { width:100%; height:100%; object-fit:cover; display:block; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3 cursor-pointer" role="button" tabindex="0" aria-label="Go to home" onclick="showSearchInterface()" onkeypress="if(event.key==='Enter') showSearchInterface()">
                    <div class="w-8 h-8 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-sm">BV</span>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900">BookVerse</h1>
                </div>
                
                <nav class="hidden md:flex space-x-6">
                    <button onclick="showSearchInterface()" class="text-gray-600 hover:text-blue-600 font-medium">Search</button>
                    <button onclick="showAuthorsListPage()" class="text-gray-600 hover:text-blue-600 font-medium">Authors</button>
                    <button onclick="showTitlesListPage()" class="text-gray-600 hover:text-blue-600 font-medium">Titles</button>
                    <button onclick="showDigitalPage()" class="text-gray-600 hover:text-blue-600 font-medium">Digital</button>
                    
                    <button onclick="showLibrariesListPage()" class="text-gray-600 hover:text-blue-600 font-medium">Libraries</button>
                </nav>
                
                <!-- Mobile menu button (visible on small screens) -->
                <button id="mobileMenuButton" onclick="toggleMobileNav()" class="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors mr-2" aria-label="Open menu" aria-expanded="false">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>

                <button onclick="toggleTheme()" id="themeToggle" class="p-2 rounded-lg hover:bg-gray-100 transition-colors" title="Toggle dark/light theme" aria-label="Toggle theme">
                    <svg id="sunIcon" class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <svg id="moonIcon" class="w-5 h-5 text-gray-600 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile navigation panel (hidden by default) -->
    <div id="mobileNav" class="md:hidden hidden fixed top-16 right-4 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-lg z-50 overflow-hidden">
        <div class="p-3">
            <button onclick="showSearchInterface(); hideMobileNav();" class="block w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">Search</button>
            <button onclick="showAuthorsListPage(); hideMobileNav();" class="block w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">Authors</button>
            <button onclick="showTitlesListPage(); hideMobileNav();" class="block w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">Titles</button>
            <button onclick="showDigitalPage(); hideMobileNav();" class="block w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">Digital</button>
            
            <button onclick="showLibrariesListPage(); hideMobileNav();" class="block w-full text-left px-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">Libraries</button>
        </div>
    </div>

    <!-- Main Content -->
    <main id="mainContent" class="max-w-7xl mx-auto px-4 py-8">
        <!-- Breadcrumb Navigation -->
        <div id="breadcrumbContainer" class="hidden mb-6 p-3 bg-white rounded-lg shadow-sm border border-gray-200">
        </div>

        <!-- Search Interface (Default View) -->
        <div id="searchInterface">
            <!-- Hero Search -->
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-gray-900 mb-4">Find Books Worldwide</h2>
                <p class="text-xl text-gray-600 mb-8">Search across global libraries with advanced filters</p>
                
                <!-- Simplified Main Search (demo-like) -->
                <div class="max-w-4xl mx-auto">
                    <div class="relative mb-4">
                        <input 
                            type="text" 
                            id="mainSearch" 
                            placeholder="Search by title or author..."
                            class="w-full px-6 py-4 text-lg border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 search-focus"
                            onkeypress="if(event.key==='Enter') showSearchResults()"
                        />
                    </div>

                    <div class="flex items-center justify-center gap-4 mt-4">
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-700">Mode:</label>
                            <label class="text-sm">
                                <input type="radio" name="searchMode" value="title" checked /> Title
                            </label>
                            <label class="text-sm">
                                <input type="radio" name="searchMode" value="author" /> Author
                            </label>
                        </div>

                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-700">Source:</label>
                            <label class="text-sm">
                                <input type="radio" name="searchSource" value="digital" checked /> Digital
                            </label>
                            <label class="text-sm">
                                <input type="radio" name="searchSource" value="catalog" /> Library Catalog
                            </label>
                        </div>

                        <button onclick="showSearchResults()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                            Search
                        </button>
                    </div>
                </div>
                
                
            </div>

            <!-- Enhanced Map & API Selector -->
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                <h3 class="text-xl font-bold text-gray-900 mb-4">üìç Global Library Access Map</h3>
                <div class="flex flex-col md:flex-row gap-6">
                    <!-- Leaflet Map Container -->
                    <div class="flex-1 min-w-[300px]">
                        <div id="libraryMap" class="w-full h-96 rounded-lg border border-gray-200 relative">
                            <!-- Map will be initialized here -->
                        </div>
                        <div class="mt-2 text-sm text-gray-600 text-center">
                            <span class="inline-flex items-center gap-2">
                                <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                                Active Libraries
                            </span>
                        </div>
                    </div>
                    <!-- API Selector & Info -->
                    <div class="flex-1 min-w-[250px] flex flex-col gap-4 justify-center">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" for="apiSourceSelect">Choose Data Source</label>
                            <select id="apiSourceSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="onApiSourceChange()" aria-label="Select API data source">
                                <option value="loc">Library of Congress (LoC) - Physical</option>
                                <option value="ia" disabled>Internet Archive (Digital Only)</option>
                                <option value="ol" disabled>Open Library (Digital Only)</option>
                            </select>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-blue-800 flex items-center gap-2">
                            <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z"/></svg>
                            <span>Currently, only the <b>Library of Congress</b> has physical locations mapped. Check out on Libraries for more information.</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">
                            <b>LoC API:</b> <a href="https://www.loc.gov/books/?fo=json" target="_blank" rel="noopener" class="underline text-blue-600">https://www.loc.gov/books/?fo=json</a><br>
                            <b>SRU Endpoint:</b> <a href="https://www.loc.gov/standards/sru/" target="_blank" rel="noopener" class="underline text-blue-600">SRU Info</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Results (Hidden by default) -->
        <div id="searchResults" class="hidden">
            <!-- Content will be dynamically loaded -->
        </div>

        <!-- Other Pages (Hidden by default) -->
        <div id="authorPage" class="hidden"></div>
        <div id="authorsListPage" class="hidden"></div>
        <div id="titlesListPage" class="hidden"></div>
        <div id="digitalPage" class="hidden"></div>
        <div id="librariesListPage" class="hidden"></div>
        
        
        <div id="libraryDetailsPage" class="hidden"></div>
    </main>

    <!-- Book Details Modal -->
    <div id="bookModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div id="bookModalContent">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // DATABASE CONNECTION CONFIGURATION
        // ===========================================
        
        // TODO: Replace these with your actual API endpoints
        const API_CONFIG = {
            baseUrl: 'https://your-api-domain.com/api',
            endpoints: {
                search: '/search',
                books: '/books',
                authors: '/authors',
                libraries: '/libraries',
            
            },
            // Add your API key if needed
            apiKey: 'your-api-key-here'
        };

        // ===========================================
        // API HELPER FUNCTIONS
        // ===========================================
        
        async function apiRequest(endpoint, params = {}) {
            try {
                // If API_CONFIG is still the placeholder, avoid noisy network calls and return a clear error
                if (API_CONFIG.baseUrl && API_CONFIG.baseUrl.includes('your-api-domain.com')) {
                    console.debug('API_CONFIG baseUrl is placeholder; skipping network call to', endpoint);
                    return { error: 'no_api_config', data: [] };
                }

                // Allow endpoint to be absolute URL or relative path.
                let url;
                try {
                    // If endpoint is a full URL this will succeed
                    url = new URL(endpoint);
                } catch (e) {
                    // Otherwise resolve relative to baseUrl; preserve base path if baseUrl contains a path
                    const base = API_CONFIG.baseUrl || '';
                    if (endpoint && endpoint.startsWith('/')) {
                        // Join without dropping base path
                        url = new URL(base.replace(/\/$/, '') + endpoint);
                    } else {
                        url = new URL(endpoint, base);
                    }
                }

                // Append params to the URL's search params
                Object.keys(params).forEach(key => {
                    const val = params[key];
                    if (val !== null && val !== undefined) {
                        url.searchParams.append(key, String(val));
                    }
                });

                const headers = {
                    'Content-Type': 'application/json'
                };

                // Add API key to headers if configured (do not log the key)
                if (API_CONFIG.apiKey && API_CONFIG.apiKey !== 'your-api-key-here') {
                    headers['Authorization'] = `Bearer ${API_CONFIG.apiKey}`;
                }

                // Helpful debug log for endpoint troubleshooting
                console.debug('API request URL:', url.toString());

                const response = await fetch(url.toString(), { headers });

                const text = await response.text();

                if (!response.ok) {
                    // Try to include server returned body for better diagnostics
                    let bodySnippet = '';
                    try {
                        bodySnippet = text ? ` - ${text.substring(0, 1000)}` : '';
                    } catch (e) {
                        bodySnippet = '';
                    }
                    throw new Error(`HTTP ${response.status} ${response.statusText}${bodySnippet}`);
                }

                // Attempt to parse JSON; if empty response return empty object
                if (!text) return {};
                try {
                    return JSON.parse(text);
                } catch (e) {
                    // If response is not JSON, return it as text under 'data'
                    return { data: text };
                }
            } catch (error) {
                console.error('API request failed:', error);
                return { error: error.message, data: [] };
            }
        }

        // ===========================================
        // DATA FETCHING FUNCTIONS
        // ===========================================
        
        async function fetchBooks(filters = {}) {
            showLoading('Loading books...');
            const result = await apiRequest(API_CONFIG.endpoints.books, filters);
            hideLoading();
            const data = result.data || [];
            // If backend missing or returned error/empty, fall back to Open Library search
            if (result.error || !data || (Array.isArray(data) && data.length === 0)) {
                try {
                    const q = filters.q || filters.query || '';
                    if (filters.digital) {
                        // Combined digital search: Open Library + Internet Archive
                        const combined = await digitalSearch(q || 'the');
                        return combined;
                    }

                    const ol = await performTitleSearch(q || 'the', { digital: !!filters.digital });
                    return ol;
                } catch (e) {
                    return [];
                }
            }

            return data;
        }

        async function fetchAuthors(filters = {}) {
            showLoading('Loading authors...');
            const result = await apiRequest(API_CONFIG.endpoints.authors, filters);
            hideLoading();
            const data = result.data || [];
            if (result.error || !data || (Array.isArray(data) && data.length === 0)) {
                try {
                    const q = filters.q || filters.query || 'a';
                    const ol = await performAuthorSearch(q);
                    return ol;
                } catch (e) {
                    return [];
                }
            }

            return data;
        }

        async function fetchLibraries() {
            showLoading('Loading libraries...');
            const result = await apiRequest(API_CONFIG.endpoints.libraries);
            hideLoading();
            const data = result.data || [];
            if (result.error || !data || (Array.isArray(data) && data.length === 0)) {
                // Fallback: surface Library of Congress as a sample library
                return [
                    {
                        id: 'loc',
                        name: 'Library of Congress',
                        city: 'Washington',
                        country: 'USA',
                        established: 1800,
                        totalBooks: 17000000,
                        digitalAccess: true,
                        physicalAccess: true,
                        address: '101 Independence Ave SE, Washington, DC',
                        website: 'https://www.loc.gov',
                        contact: null,
                        bookCount: 17000000,
                        availableBooks: 1000000
                    }
                ];
            }

            return data;
        }

        // Override: Use unified search for external APIs with map integration
        async function searchBooks(query, filters = {}) {
            showLoading('Searching...');
            let results = await searchBooksUnified(query, filters);
            
            // If we have physical location data, add markers to map
            if (libraryMap && results.length > 0) {
                clearBookMarkers();
                
                // Extract physical locations from search results
                const physicalLocations = [];
                results.forEach(result => {
                    if (result.item && result.item.physicalCopies) {
                        result.item.physicalCopies.forEach(copy => {
                            if (copy.coordinates) {
                                physicalLocations.push({
                                    lat: copy.coordinates.lat,
                                    lng: copy.coordinates.lng,
                                    libraryName: copy.libraryName || 'Unknown Library',
                                    address: copy.address || '',
                                    callNumber: copy.callNumber,
                                    available: copy.available
                                });
                            }
                        });
                    }
                });
                
                if (physicalLocations.length > 0) {
                    addBookLocationMarkers(physicalLocations);
                }
            }
            
            hideLoading();
            return results;
        }

        async function fetchBookById(bookId) {
            showLoading('Loading book details...');
            try {
                // If bookId looks like an OpenLibrary key or ISBN, prefer OL API
                if (!bookId) { hideLoading(); return null; }
                const isOL = String(bookId).startsWith('/works/') || String(bookId).startsWith('/books/') || String(bookId).startsWith('OL') || String(bookId).startsWith('ISBN:') || String(bookId).includes('/works/') || String(bookId).includes('/books/');
                if (isOL) {
                    const ol = await fetchOpenLibraryWorkOrEdition(bookId);
                    hideLoading();
                    return ol || null;
                }
                const result = await apiRequest(`${API_CONFIG.endpoints.books}/${bookId}`);
                hideLoading();
                return result.data || null;
            } catch (e) {
                hideLoading();
                console.error('fetchBookById fallback error', e);
                return null;
            }
        }

        async function fetchAuthorById(authorId) {
            showLoading('Loading author details...');
            try {
                if (!authorId) { hideLoading(); return null; }
                const isOL = String(authorId).startsWith('/authors/') || String(authorId).startsWith('OL');
                if (isOL) {
                    const author = await fetchOpenLibraryAuthor(authorId);
                    hideLoading();
                    return author || null;
                }
                const result = await apiRequest(`${API_CONFIG.endpoints.authors}/${authorId}`);
                hideLoading();
                return result.data || null;
            } catch (e) {
                hideLoading();
                console.error('fetchAuthorById fallback error', e);
                return null;
            }
        }

        async function fetchLibraryById(libraryId) {
            showLoading('Loading library details...');
            const result = await apiRequest(`${API_CONFIG.endpoints.libraries}/${libraryId}`);
            hideLoading();
            return result.data || null;
        }

        // Open Library helpers (use public endpoints directly)
        async function fetchOpenLibraryWorkOrEdition(id) {
            // Accept keys like '/works/OL...W' or '/books/OL...M' or direct OL ids
            try {
                let url;
                if (id && id.startsWith('/')) url = `https://openlibrary.org${id}.json`;
                else if (id && (id.startsWith('OL') || id.includes('/works/') || id.includes('/books/'))) url = `https://openlibrary.org${id}.json`;
                else url = `https://openlibrary.org/works/${encodeURIComponent(id)}.json`;

                const res = await fetch(url);
                if (!res.ok) return null;
                const data = await res.json();
                // normalize authors if necessary
                if (data.authors && Array.isArray(data.authors)) {
                    // fetch author names if nested
                    const names = await Promise.all(data.authors.map(async a => {
                        try {
                            if (a.author && a.author.key) {
                                const ar = await fetch(`https://openlibrary.org${a.author.key}.json`).then(r => r.json());
                                return { name: ar.name, key: a.author.key };
                            }
                            return { name: a.name || '', key: a.key || '' };
                        } catch (e) { return { name: '', key: '' }; }
                    }));
                    data.authors = names;
                }
                return data;
            } catch (e) { console.error('fetchOpenLibraryWorkOrEdition', e); return null; }
        }

        async function fetchOpenLibraryAuthor(authorKey) {
            if (!authorKey) return null;
            try {
                const key = authorKey.startsWith('/authors/') ? authorKey : (authorKey.startsWith('OL') ? `/authors/${authorKey}` : `/authors/${authorKey}`);
                const url = `https://openlibrary.org${key}.json`;
                const res = await fetch(url);
                if (!res.ok) return null;
                const data = await res.json();
                return data;
            } catch (e) { console.error('fetchOpenLibraryAuthor', e); return null; }
        }

        // ===========================================
        // UI STATE MANAGEMENT
        // ===========================================
        
        let currentView = 'search';
        let searchResults = [];
        let breadcrumbHistory = [];
    // Simplified: no advanced filters in this UI
    let filtersVisible = false;

        // ===========================================
        // LOADING STATES
        // ===========================================
        
        function showLoading(message = 'Loading...') {
            const loadingHtml = `
                <div class="flex items-center justify-center py-12">
                    <div class="text-center">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-gray-600">${message}</p>
                    </div>
                </div>
            `;
            
            // Show loading in the current active container
            const activeContainer = document.querySelector('#searchResults:not(.hidden), #authorsListPage:not(.hidden), #titlesListPage:not(.hidden), #digitalPage:not(.hidden), #librariesListPage:not(.hidden)');
            if (activeContainer) {
                activeContainer.innerHTML = loadingHtml;
            }
        }

        function hideLoading() {
            // Loading will be replaced by actual content
        }

        function showNoResults(message = 'No results found', suggestion = 'Try different search terms or adjust your filters') {
            return `
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">üìö</div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">${message}</h3>
                    <p class="text-gray-600 mb-4">${suggestion}</p>
                    <button onclick="showSearchInterface()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                        Back to Search
                    </button>
                </div>
            `;
        }

        // ===========================================
        // NAVIGATION FUNCTIONS
        // ===========================================
        
        function hideAllPages() {
            const pages = [
                'searchInterface', 'searchResults', 'authorPage', 'authorsListPage', 
                'titlesListPage', 'digitalPage', 'librariesListPage',
                'publicDomainAuthorsPage', 'publicDomainTitlesPage', 'libraryDetailsPage'
            ];
            pages.forEach(pageId => {
                const element = document.getElementById(pageId);
                if (element) element.classList.add('hidden');
            });
        }

        function showSearchInterface(addBreadcrumb = true) {
            if (addBreadcrumb) {
                clearBreadcrumbs();
                addToBreadcrumb('üîç Search', 'showSearchInterface');
            }
            
            currentView = 'search';
            hideAllPages();
            document.getElementById('searchInterface').classList.remove('hidden');
        }

        async function showSearchResults(addBreadcrumb = true) {
            const query = document.getElementById('mainSearch').value || '';
            if (!query.trim()) return;

            // Read mode and source from radios
            const mode = document.querySelector('input[name="searchMode"]:checked')?.value || 'title';
            const source = document.querySelector('input[name="searchSource"]:checked')?.value || 'digital';

            if (addBreadcrumb) {
                addToBreadcrumb(`üìã Results: "${query}"`, 'showSearchResults', { query: query });
            }

            // Route based on mode and source
            hideAllPages();
            if (source === 'digital') {
                // Author searches should show authors list
                if (mode === 'author') {
                    currentView = 'authorsList';
                    document.getElementById('authorsListPage').classList.remove('hidden');
                    const authors = await performAuthorSearch(query);
                    searchResults = authors.map(a => ({ type: 'author', item: a }));
                    renderAuthorsListPage(authors);
                    return;
                }

                // For title searches prefer OpenLibrary / Internet Archive
                currentView = 'digital';
                document.getElementById('digitalPage').classList.remove('hidden');
                const results = await searchBooks(query, { digital: true, mode });
                searchResults = results;
                // renderDigitalPage expects an array of book items (not wrapper objects)
                const items = (results || []).map(r => r.item ? r.item : r);
                renderDigitalPage(items);
                return;
            }

            // Library catalog search (physical)
            if (mode === 'author') {
                currentView = 'authorsList';
                document.getElementById('authorsListPage').classList.remove('hidden');
                const authors = await performAuthorSearch(query);
                searchResults = authors.map(a => ({ type: 'author', item: a }));
                renderAuthorsListPage(authors);
                return;
            }

            // Title/catalog search: use unified search that also maps physical locations
            currentView = 'results';
            document.getElementById('searchResults').classList.remove('hidden');
            const results = await searchBooks(query, { mode, source: 'catalog' });
            searchResults = results;
            renderSearchResults(query);
        }

        async function showAuthorsListPage(addBreadcrumb = true) {
            if (addBreadcrumb) {
                addToBreadcrumb('‚úçÔ∏è All Authors', 'showAuthorsListPage');
            }
            
            currentView = 'authorsList';
            hideAllPages();
            document.getElementById('authorsListPage').classList.remove('hidden');
            
            const authors = await fetchAuthors();
            renderAuthorsListPage(authors);
        }

        async function showTitlesListPage(addBreadcrumb = true) {
            if (addBreadcrumb) {
                addToBreadcrumb('üìö All Titles', 'showTitlesListPage');
            }
            
            currentView = 'titlesList';
            hideAllPages();
            document.getElementById('titlesListPage').classList.remove('hidden');
            
            const books = await fetchBooks();
            renderTitlesListPage(books);
        }

        async function showDigitalPage(addBreadcrumb = true) {
            if (addBreadcrumb) {
                addToBreadcrumb('üì± Digital Collection', 'showDigitalPage');
            }
            
            currentView = 'digital';
            hideAllPages();
            document.getElementById('digitalPage').classList.remove('hidden');
            
            const digitalBooks = await fetchBooks({ digital: true });
            renderDigitalPage(digitalBooks);
        }

        async function showLibrariesListPage(addBreadcrumb = true) {
            if (addBreadcrumb) {
                addToBreadcrumb('üèõÔ∏è Partner Libraries', 'showLibrariesListPage');
            }
            
            currentView = 'librariesList';
            hideAllPages();
            document.getElementById('librariesListPage').classList.remove('hidden');
            
            const libraries = await fetchLibraries();
            renderLibrariesListPage(libraries);
        }

        

        // ===========================================
        // RENDER FUNCTIONS
        // ===========================================
        
        function renderSearchResults(query) {
            const container = document.getElementById('searchResults');
            
            if (searchResults.length === 0) {
                container.innerHTML = showNoResults(
                    `No results found for "${query}"`,
                    'Try different keywords or adjust your filters'
                );
                return;
            }

            const bookResults = searchResults.filter(r => r.type === 'book').length;
            const authorResults = searchResults.filter(r => r.type === 'author').length;
            
            container.innerHTML = `
                <div class="mb-8">
                    
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Search Results</h2>
                            <p class="text-gray-600">Found ${searchResults.length} results for "${query}"</p>
                            ${bookResults > 0 ? `<p class="text-sm text-gray-500">${bookResults} books ‚Ä¢ ${authorResults} authors</p>` : ''}
                        </div>
                        <button onclick="showSearchInterface()" class="text-blue-600 hover:text-blue-700 font-medium">
                            ‚Üê Back to Search
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        ${searchResults.map(result => renderSearchResultItem(result)).join('')}
                    </div>
                </div>
            `;
        }

        function renderSearchResultItem(result) {
            const { type, item } = result;
            
            if (type === 'book') {
                return `
                    <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200 catalog-item cursor-pointer" onclick="showBookDetails('${item.id}')">
                        <div class="flex items-start space-x-4">
                            <div class="w-16 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">
                                üìñ
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-900 mb-1">${item.title}</h3>
                                <p class="text-gray-600 mb-2">by ${item.author}</p>
                                ${item.description ? `<p class="text-gray-700 text-sm mb-3">${item.description}</p>` : ''}
                                
                                <div class="flex items-center space-x-4 text-sm">
                                    ${item.rating ? `<span class="text-yellow-600">‚≠ê ${item.rating}</span>` : ''}
                                    <span class="text-green-600">üì± ${item.digitalAvailable ? 'Digital Available' : 'Physical Only'}</span>
                                    <span class="text-blue-600">üìç ${item.libraryCount || 0} libraries</span>
                                </div>
                                
                                <div class="flex items-center space-x-2 mt-2">
                                    ${item.genre ? `<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">${item.genre}</span>` : ''}
                                    ${item.publishYear ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">${item.publishYear}</span>` : ''}
                                    ${item.pages ? `<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">${item.pages} pages</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (type === 'author') {
                return `
                    <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200 catalog-item cursor-pointer" onclick="showAuthorPage('${item.id}')">
                        <div class="flex items-start space-x-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                ‚úçÔ∏è
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-900 mb-1">${item.name}</h3>
                                <p class="text-gray-600 mb-2">${(item.nationality ? item.nationality : '')}${(item.nationality && item.birthYear) ? ' ‚Ä¢ ' : ''}${(item.birthYear ? item.birthYear : '')}</p>
                                <p class="text-gray-700 text-sm mb-3">${item.biography || 'No biography available'}</p>
                                
                                
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function renderAuthorsListPage(authors) {
            const container = document.getElementById('authorsListPage');
            
            if (!authors || authors.length === 0) {
                container.innerHTML = showNoResults('No authors found', 'Check your database connection');
                return;
            }

            container.innerHTML = `
                <div class="mb-8">
                    
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-900">All Authors</h2>
                            <p class="text-gray-600">${authors.length} authors in our collection</p>
                        </div>
                        <button onclick="showSearchInterface()" class="text-blue-600 hover:text-blue-700 font-medium">
                            ‚Üê Back to Search
                        </button>
                    </div>
                    
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${authors.map(author => `
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 catalog-item cursor-pointer" onclick="showAuthorPage('${author.id}')">
                                <div class="flex items-start space-x-4">
                                    <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                        ‚úçÔ∏è
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-lg font-bold text-gray-900 mb-1">${author.name}</h3>
                                        <p class="text-gray-600 mb-2">${(author.nationality ? author.nationality : '')}${(author.nationality && author.birthYear) ? ' ‚Ä¢ Born ' : (author.birthYear ? 'Born ' : '')}${(author.birthYear ? author.birthYear : '')}</p>
                                        <p class="text-gray-700 text-sm mb-3 line-clamp-2">${author.biography || 'No biography available'}</p>
                                        
                                        
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderTitlesListPage(books) {
            const container = document.getElementById('titlesListPage');
            
            if (!books || books.length === 0) {
                container.innerHTML = showNoResults('No books found', 'Check your database connection');
                return;
            }

            container.innerHTML = `
                <div class="mb-8">
                    
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-900">All Titles</h2>
                            <p class="text-gray-600">${books.length} books in our collection</p>
                        </div>
                        <button onclick="showSearchInterface()" class="text-blue-600 hover:text-blue-700 font-medium">
                            ‚Üê Back to Search
                        </button>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        ${books.map(book => `
                            <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200 catalog-item cursor-pointer" onclick="showBookDetails('${book.id}')">
                                <div class="flex items-start space-x-4">
                                    <div class="w-16 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">
                                        üìñ
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-lg font-bold text-gray-900 mb-1">${book.title}</h3>
                                        <p class="text-gray-600 mb-2">by ${book.author}</p>
                                        ${book.description ? `<p class="text-gray-700 text-sm mb-3">${book.description}</p>` : ''}
                                        
                                        <div class="flex items-center space-x-4 text-sm">
                                            ${book.rating ? `<span class="text-yellow-600">‚≠ê ${book.rating}</span>` : ''}
                                            <span class="text-green-600">üì± ${book.digitalAvailable ? 'Digital Available' : 'Physical Only'}</span>
                                            <span class="text-blue-600">üìç ${book.libraryCount || 0} libraries</span>
                                        </div>
                                        
                                        <div class="flex items-center space-x-2 mt-2">
                                            ${book.genre ? `<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">${book.genre}</span>` : ''}
                                            ${book.publishYear ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">${book.publishYear}</span>` : ''}
                                            ${book.pages ? `<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">${book.pages} pages</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderDigitalPage(digitalBooks) {
            const container = document.getElementById('digitalPage');
            
            container.innerHTML = `
                <div class="mb-8">
                    
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-900">üì± Digital Collection</h2>
                            <p class="text-gray-600">${digitalBooks?.length || 0} digital books available</p>
                        </div>
                        <button onclick="showSearchInterface()" class="text-blue-600 hover:text-blue-700 font-medium">
                            ‚Üê Back to Search
                        </button>
                    </div>
                    
                    <!-- Digital Stats -->
                    <div class="grid md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                            <div class="text-3xl font-bold">${digitalBooks?.length || 0}</div>
                            <div class="text-blue-100">Total Digital Books</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white">
                            <div class="text-3xl font-bold">0</div>
                            <div class="text-green-100">Digital Exclusive</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white">
                            <div class="text-3xl font-bold">0</div>
                            <div class="text-purple-100">Partner Libraries</div>
                        </div>
                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white">
                            <div class="text-3xl font-bold">0</div>
                            <div class="text-orange-100">Total Downloads</div>
                        </div>
                    </div>
                    
                    <!-- Search bar for digital sources -->
                    <div class="mt-4 mb-6">
                        <div class="flex gap-3">
                            <input id="digitalSearchInput" type="text" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg" placeholder="Search Open Library + Internet Archive..." onkeypress="if(event.key==='Enter') doDigitalSearch()" />
                            <button onclick="doDigitalSearch()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Search</button>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">Searches both Open Library and Internet Archive for digital copies and covers.</div>
                    </div>

                    ${digitalBooks && digitalBooks.length > 0 ? `
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                            <h3 class="text-xl font-bold text-gray-900 mb-6">üìñ Digital Books Collection</h3>
                            <div class="grid md:grid-cols-2 gap-6">
                                ${digitalBooks.map(book => `
                                    <div class="border border-gray-200 rounded-lg p-6 cursor-pointer hover:shadow-md transition-shadow" onclick="showBookDetails('${book.id}')">
                                        <div class="flex items-start space-x-4">
                                            <div class="w-16 h-20 rounded-lg overflow-hidden bg-gray-100 flex items-center justify-center">
                                                ${book.coverUrl ? `<img src="${book.coverUrl}" alt="Cover" class="w-full h-full object-cover">` : 'üì±'}
                                            </div>
                                            <div class="flex-1">
                                                <h4 class="text-lg font-bold text-gray-900 mb-1">${book.title}</h4>
                                                <p class="text-gray-600 mb-2">by ${book.author}</p>
                                                ${book.description ? `<p class="text-gray-700 text-sm mb-3">${book.description}</p>` : ''}
                                                
                                                <div class="flex items-center space-x-4 text-sm mb-3">
                                                    ${book.rating ? `<span class="text-yellow-600">‚≠ê ${book.rating}</span>` : ''}
                                                    ${book.downloadCount ? `<span class="text-green-600">üì• ${book.downloadCount} downloads</span>` : ''}
                                                </div>
                                                
                                                <div class="flex items-center space-x-2">
                                                    ${book.genre ? `<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">${book.genre}</span>` : ''}
                                                    ${book.publishYear ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">${book.publishYear}</span>` : ''}
                                                    <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Digital</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : showNoResults('No digital books found', 'Check your database connection')}
                </div>
            `;

            // Wire the digital search function used by the search bar
            window.doDigitalSearch = async function() {
                const q = document.getElementById('digitalSearchInput').value || '';
                if (!q.trim()) return;
                const container = document.getElementById('digitalPage');
                // Show loading
                container.querySelector('#digitalSearchInput').disabled = true;
                const results = await digitalSearch(q, 30);
                container.querySelector('#digitalSearchInput').disabled = false;

                // Merge results into a normalized list and render using existing digital layout
                renderDigitalPage(results);
            };
        }

        // Internet Archive search helper (simple, CORS-friendly public search via IA's search API)
        async function searchInternetArchive(query, limit = 20) {
            if (!query) return [];
            try {
                const q = encodeURIComponent(query + ' mediatype:(texts OR books)');
                const url = `https://archive.org/advancedsearch.php?q=${q}&fl[]=identifier,creator,title,description,mediatype,year&rows=${limit}&output=json`;
                const res = await fetch(url);
                if (!res.ok) return [];
                const data = await res.json();
                const docs = (data.response && data.response.docs) || [];
                return docs.map(d => ({
                    id: d.identifier ? `ia:${d.identifier}` : (`ia:${encodeURIComponent(d.title || '')}`),
                    title: d.title || '',
                    author: d.creator || '',
                    description: d.description || '',
                    digitalAvailable: true,
                    source: 'ia',
                    iaIdentifier: d.identifier || null,
                    publishYear: d.year || null,
                    coverUrl: d.identifier ? `https://archive.org/services/img/${d.identifier}` : ''
                }));
            } catch (e) {
                console.warn('searchInternetArchive error', e);
                return [];
            }
        }

        // Combined digital search: Open Library title search + Internet Archive
        async function digitalSearch(query, limit = 20) {
            if (!query) return [];
            try {
                const olPromise = performTitleSearch(query, { digital: true });
                const iaPromise = searchInternetArchive(query, limit);
                const [olResults, iaResults] = await Promise.all([olPromise, iaPromise]);

                // normalize Open Library results to include source flag
                const olNorm = (olResults || []).map(o => ({ ...o, source: 'ol', coverUrl: o.coverUrl || (o.coverId ? `https://covers.openlibrary.org/b/id/${o.coverId}-M.jpg` : '') }));

                // Merge by title/author de-duplication (simple): prefer OL then IA
        const merged = [];
                const seen = new Set();
                olNorm.forEach(it => {
                    const key = (it.title || '') + '|' + (it.author || '');
                    seen.add(key.toLowerCase());
                    merged.push(it);
                });
                (iaResults || []).forEach(it => {
                    const key = (it.title || '') + '|' + (it.author || '');
                    if (!seen.has(key.toLowerCase())) {
            merged.push(it);
                    }
                });

                return merged.slice(0, limit);
            } catch (e) {
                console.error('digitalSearch failed', e);
                return [];
            }
        }

        function renderLibrariesListPage(libraries) {
            const container = document.getElementById('librariesListPage');
            
            if (!libraries || libraries.length === 0) {
                container.innerHTML = showNoResults('No libraries found', 'Check your database connection');
                return;
            }

            container.innerHTML = `
                <div class="mb-8">
                    
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-900">Partner Libraries</h2>
                            <p class="text-gray-600">${libraries.length} libraries worldwide</p>
                        </div>
                        <button onclick="showSearchInterface()" class="text-blue-600 hover:text-blue-700 font-medium">
                            ‚Üê Back to Search
                        </button>
                    </div>
                    
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${libraries.map(library => `
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 catalog-item cursor-pointer" onclick="showLibraryDetails('${library.id}')">
                                <div class="flex items-start space-x-4">
                                    <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-orange-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">
                                        üèõÔ∏è
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-lg font-bold text-gray-900 mb-1">${library.name}</h3>
                                        <p class="text-gray-600 mb-2">${library.city}, ${library.country}</p>
                                        <p class="text-gray-700 text-sm mb-3">${library.established ? `Established ${library.established}` : ''}${(library.established && library.totalBooks) ? ' ‚Ä¢ ' : ''}${library.totalBooks ? `${library.totalBooks.toLocaleString()} total books` : ''}</p>
                                        
                                        <div class="flex items-center space-x-4 text-sm">
                                            <span class="text-blue-600">üìö ${library.bookCount || 0} titles</span>
                                            <span class="text-green-600">‚úÖ ${library.availableBooks || 0} available</span>
                                        </div>
                                        
                                        <div class="flex items-center space-x-2 mt-2">
                                            ${library.digitalAccess ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Digital</span>' : ''}
                                            ${library.physicalAccess ? '<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">Physical</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        

        // ===========================================
        // BREADCRUMB FUNCTIONS
        // ===========================================
        
        function addToBreadcrumb(title, action, data = null) {
            breadcrumbHistory = breadcrumbHistory.filter(item => item.title !== title);
            breadcrumbHistory.push({
                title: title,
                action: action,
                data: data,
                timestamp: Date.now()
            });
            
            if (breadcrumbHistory.length > 10) {
                breadcrumbHistory = breadcrumbHistory.slice(-10);
            }
            
            updateBreadcrumbDisplay();
        }

        function updateBreadcrumbDisplay() {
            const breadcrumbContainer = document.getElementById('breadcrumbContainer');
            if (!breadcrumbContainer) return;
            
            if (breadcrumbHistory.length <= 1) {
                breadcrumbContainer.classList.add('hidden');
                return;
            }
            
            breadcrumbContainer.classList.remove('hidden');
            breadcrumbContainer.innerHTML = renderBreadcrumbs();
        }

        function renderBreadcrumbs() {
            if (breadcrumbHistory.length <= 1) return '';
            
            const breadcrumbItems = breadcrumbHistory.map((item, index) => {
                const isLast = index === breadcrumbHistory.length - 1;
                
                if (isLast) {
                    return `<span class="text-gray-900 font-medium">${item.title}</span>`;
                }
                
                return `
                    <button onclick="navigateToBreadcrumb(${index})" class="text-blue-600 hover:text-blue-700 hover:underline">
                        ${item.title}
                    </button>
                    <svg class="w-4 h-4 text-gray-400 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                `;
            }).join('');
            
            return `
                <div class="mb-6 p-3 bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center text-sm">
                        ${breadcrumbItems}
                    </div>
                </div>
            `;
        }

        function clearBreadcrumbs() {
            breadcrumbHistory = [];
            updateBreadcrumbDisplay();
        }

        function navigateToBreadcrumb(index) {
            const item = breadcrumbHistory[index];
            if (!item) return;
            
            breadcrumbHistory = breadcrumbHistory.slice(0, index + 1);
            
            // Execute navigation based on action
            if (item.action === 'showSearchInterface') {
                showSearchInterface(false);
            } else if (item.action === 'showSearchResults') {
                document.getElementById('mainSearch').value = item.data.query;
                showSearchResults(false);
            } else if (item.action === 'showLibrariesListPage') {
                showLibrariesListPage(false);
            } else if (item.action === 'showLibraryDetails') {
                // data should include libraryId
                const libId = item.data && item.data.libraryId;
                if (libId) showLibraryDetails(libId, false);
            } else if (item.action === 'showAuthorPage') {
                const authorId = item.data && item.data.authorId;
                if (authorId) showAuthorPage(authorId, false);
            } else if (item.action === 'showBookDetails') {
                const bookId = item.data && item.data.bookId;
                if (bookId) showBookDetails(bookId, false);
            }
        }

        // ===========================================
        // DETAIL FUNCTIONS (PLACEHOLDERS)
        // ===========================================
        
        async function showBookDetails(bookId, addBreadcrumb = true) {
            // Use Open Library to fetch work/edition details and render inside the modal
            try {
                const ol = await fetchOpenLibraryWorkOrEdition(bookId);
                if (!ol) {
                    document.getElementById('bookModalContent').innerHTML = `<div class="p-6"> <p class="text-red-600">Book details not found.</p></div>`;
                    document.getElementById('bookModal').classList.remove('hidden');
                    return;
                }

                if (addBreadcrumb) {
                    addToBreadcrumb(`üìñ ${ol.title || 'Book'}`, 'showBookDetails', { bookId: bookId });
                }

                const coverId = ol.covers && ol.covers[0];
                const coverUrl = coverId ? `https://covers.openlibrary.org/b/id/${coverId}-L.jpg` : '';
                const authors = (ol.authors || []).map(a => a.name || a.author?.key || '').filter(Boolean);
                const description = (ol.description && (typeof ol.description === 'string' ? ol.description : ol.description.value)) || (ol.excerpts && ol.excerpts[0]?.excerpt) || '';

                // Attempt to fetch edition info for richer metadata when this is a work
                let edition = null;
                try {
                    if (ol.key && ol.key.startsWith('/works/')) {
                        const edRes = await fetch(`https://openlibrary.org${ol.key}/editions.json?limit=5`).then(r => r.ok ? r.json() : null);
                        if (edRes && edRes.entries && edRes.entries.length) {
                            edition = edRes.entries.find(e => e.isbn_13 || e.isbn_10) || edRes.entries[0];
                        }
                    }
                } catch (e) { /* ignore edition fetch errors */ }

                const identifiers = (edition && edition.identifiers) || ol.identifiers || {};
                const isbn = (identifiers.isbn_10 && identifiers.isbn_10[0]) || (identifiers.isbn_13 && identifiers.isbn_13[0]) || null;
                const lccn = (identifiers.lccn && identifiers.lccn[0]) || null;
                const publishers = (edition && edition.publishers) || ol.publishers || [];
                const publishDate = (edition && edition.publish_date) || ol.first_publish_date || (ol.created && ol.created.value) || '';
                const pages = (edition && edition.number_of_pages) || ol.number_of_pages || null;
                const subjects = ol.subjects || (edition && edition.subjects) || [];
                const langs = (edition && edition.languages) || ol.languages || [];
                const languageNames = langs.map(l => (typeof l === 'string' ? l : (l.key || '')).replace('/languages/','')).filter(Boolean);

                const locLink = isbn ? `https://catalog.loc.gov/vwebv/search?searchArg=${encodeURIComponent(isbn)}&searchCode=ISBN` : (lccn ? `https://id.loc.gov/resources/bibs/${encodeURIComponent(lccn)}` : null);

                document.getElementById('bookModalContent').innerHTML = `
                    <div class="p-6 max-w-3xl">
                        <div class="flex items-start gap-6">
                            <div class="flex-shrink-0">
                                ${coverUrl ? `<img src="${coverUrl}" alt="Cover" class="rounded-lg w-40">` : '<div class="w-40 h-56 bg-gray-100 rounded-lg flex items-center justify-center">üìñ</div>'}
                            </div>
                            <div class="flex-1">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <h2 class="text-2xl font-bold text-gray-900">${ol.title || 'Untitled'}</h2>
                                        <p class="text-gray-600">${authors.join(', ')}</p>
                                    </div>
                                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>

                                ${description ? `<div class="mt-4 text-gray-700">${description}</div>` : ''}

                                <div class="mt-4 text-sm text-gray-700">
                                    ${publishers.length ? `<div><strong>Publisher:</strong> ${publishers.join(', ')}</div>` : ''}
                                    ${publishDate ? `<div><strong>Published:</strong> ${publishDate}</div>` : ''}
                                    ${pages ? `<div><strong>Pages:</strong> ${pages}</div>` : ''}
                                    ${languageNames.length ? `<div><strong>Language(s):</strong> ${languageNames.join(', ')}</div>` : ''}
                                    ${isbn ? `<div><strong>ISBN:</strong> ${isbn}</div>` : ''}
                                </div>

                                <div class="mt-4 text-sm text-blue-700">
                                    <a href="https://openlibrary.org${ol.key || ''}" target="_blank" rel="noopener">Open Library page</a>
                                    ${ol.ocaid ? ` ‚Ä¢ <a href="https://archive.org/details/${ol.ocaid}" target="_blank" rel="noopener">Internet Archive</a>` : ''}
                                    ${locLink ? ` ‚Ä¢ <a href="${locLink}" target="_blank" rel="noopener">Library of Congress</a>` : ''}
                                </div>
                            </div>
                        </div>
                        ${subjects && subjects.length ? `<div class="mt-6"><strong>Subjects:</strong> ${subjects.slice(0,10).join(', ')}</div>` : ''}
                        ${edition && edition.publishers ? `<div class="mt-3 text-xs text-gray-500">Edition info: ${edition.key || ''}</div>` : ''}
                    </div>
                `;

                document.getElementById('bookModal').classList.remove('hidden');
            } catch (err) {
                console.error('showBookDetails error', err);
                document.getElementById('bookModalContent').innerHTML = `<div class="p-6"><p class="text-red-600">Failed to load book details.</p></div>`;
                document.getElementById('bookModal').classList.remove('hidden');
            }
        }

        // Mobile nav helpers
        function toggleMobileNav() {
            const nav = document.getElementById('mobileNav');
            const btn = document.getElementById('mobileMenuButton');
            if (!nav) return;
            const isHidden = nav.classList.contains('hidden');
            if (isHidden) {
                nav.classList.remove('hidden');
                btn.setAttribute('aria-expanded', 'true');
            } else {
                nav.classList.add('hidden');
                btn.setAttribute('aria-expanded', 'false');
            }
        }

        function hideMobileNav() {
            const nav = document.getElementById('mobileNav');
            const btn = document.getElementById('mobileMenuButton');
            if (!nav) return;
            nav.classList.add('hidden');
            if (btn) btn.setAttribute('aria-expanded', 'false');
        }

        // Close mobile nav on Escape or click outside
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') hideMobileNav();
        });
        document.addEventListener('click', function(e) {
            const nav = document.getElementById('mobileNav');
            const btn = document.getElementById('mobileMenuButton');
            if (!nav || !btn) return;
            if (nav.classList.contains('hidden')) return;
            if (!nav.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
                hideMobileNav();
            }
        });

        async function showAuthorPage(authorId, addBreadcrumb = true) {
            try {
                const author = await fetchOpenLibraryAuthor(authorId);
                if (!author) {
                    document.getElementById('authorPage').innerHTML = `<div class="p-6"><p class="text-red-600">Author not found.</p></div>`;
                    document.getElementById('authorPage').classList.remove('hidden');
                    return;
                }

                if (addBreadcrumb) {
                    addToBreadcrumb(`‚úçÔ∏è ${author.name}`, 'showAuthorPage', { authorId: authorId });
                }

                hideAllPages();
                currentView = 'author';
                const container = document.getElementById('authorPage');
                container.classList.remove('hidden');

                // Fetch top works
                let works = [];
                try {
                    const res = await fetch(`https://openlibrary.org${author.key}/works.json?limit=10`).then(r => r.json());
                    works = res.entries || [];
                } catch (e) { /* ignore */ }

                container.innerHTML = `
                    <div class="mb-8">
                        <div class="flex items-start gap-6">
                            <div class="flex-shrink-0">
                                ${author.photos && author.photos[0] ? `<img src="https://covers.openlibrary.org/a/id/${author.photos[0]}-M.jpg" class="rounded-lg" alt="Author">` : `<div class="w-32 h-32 bg-gray-100 rounded-lg flex items-center justify-center">‚úçÔ∏è</div>`}
                            </div>
                            <div>
                                <h2 class="text-3xl font-bold">${author.name}</h2>
                                <p class="text-gray-600 mt-2">${author.bio ? (typeof author.bio === 'string' ? author.bio : author.bio.value) : ''}</p>
                                <div class="mt-4 text-sm text-gray-700">Top works:</div>
                                <ul class="mt-2">
                                    ${works.map(w => `<li class="mb-2"><a href="#" class="text-blue-600 underline" onclick="(function(e){e.preventDefault(); showBookDetails('${w.key}'); window.scrollTo({top:0,behavior:'smooth'}); })(event)">${w.title}</a></li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('showAuthorPage error', err);
                document.getElementById('authorPage').innerHTML = `<div class="p-6"><p class="text-red-600">Failed to load author details.</p></div>`;
                document.getElementById('authorPage').classList.remove('hidden');
            }
        }

        async function showLibraryDetails(libraryId, addBreadcrumb = true) {
            // Load library record (falls back to sample data when API is unavailable)
            let library = await fetchLibraryById(libraryId);
            // If API returned an array of results, use the first entry
            if (Array.isArray(library) && library.length > 0) {
                library = library[0];
            }

            // Normalize API responses: some backends return [] or an object lacking properties
            const isEmptyArray = Array.isArray(library) && library.length === 0;
            const isMissingName = library && typeof library === 'object' && !library.name;
            if (!library || isEmptyArray || isMissingName) {
                // If API failed to return, use a client-side fallback for LoC
                if (libraryId === 'loc') {
                    library = {
                        id: 'loc',
                        name: 'Library of Congress',
                        city: 'Washington',
                        country: 'USA',
                        established: 1800,
                        totalBooks: 17000000,
                        digitalAccess: true,
                        physicalAccess: true,
                        address: '101 Independence Ave SE, Washington, DC',
                        website: 'https://www.loc.gov',
                        contact: null,
                        bookCount: 17000000,
                        availableBooks: 1000000,
                        coordinates: { lat: 38.8886, lng: -77.0047 }
                    };
                } else {
                    alert('Library not found');
                    return;
                }
            }

            if (addBreadcrumb) {
                addToBreadcrumb(`üèõÔ∏è ${library.name}`, 'showLibraryDetails', { libraryId: libraryId });
            }

            // Ensure the details page is visible
            hideAllPages();
            currentView = 'libraryDetails';
            const container = document.getElementById('libraryDetailsPage');
            container.classList.remove('hidden');

            // Ensure we have coordinates for the map; coerce and validate numeric lat/lng
            let coords = null;
            try {
                const raw = library && library.coordinates ? library.coordinates : null;
                if (raw && typeof raw === 'object' && isFinite(raw.lat) && isFinite(raw.lng)) {
                    coords = { lat: Number(raw.lat), lng: Number(raw.lng) };
                } else if (library && library.id === 'loc') {
                    // Default to LoC coordinates when no valid coordinates provided
                    coords = { lat: 38.8886, lng: -77.0047 };
                }
            } catch (e) {
                coords = (library && library.id === 'loc') ? { lat: 38.8886, lng: -77.0047 } : null;
            }

            // Render library header and embedded LoC-style search
            container.innerHTML = `
                <div class="mb-8">
                    ${renderBreadcrumbs()}
                    <div class="flex items-start gap-6">
                        <div class="flex-shrink-0">
                            <div class="w-28 h-28 bg-gradient-to-br from-red-500 to-orange-600 rounded-lg flex items-center justify-center text-white font-bold text-2xl">üèõÔ∏è</div>
                        </div>
                        <div class="flex-1">
                            <h2 class="text-3xl font-bold text-gray-900">${library.name}</h2>
                            <p class="text-gray-600 mt-1">${library.address || (library.city && library.country ? library.city + ', ' + library.country : '')}</p>
                            <div class="mt-3 text-sm text-gray-700">
                                ${library.established ? `<strong>Established:</strong> ${library.established} ‚Ä¢ ` : ''}
                                ${library.totalBooks ? `<strong>Total holdings:</strong> ${Number(library.totalBooks).toLocaleString()} ‚Ä¢ ` : ''}
                                ${library.digitalAccess ? `<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Digital</span>` : ''}
                                ${library.physicalAccess ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">Physical</span>` : ''}
                            </div>

                            <div class="mt-4 text-sm">
                                ${library.website ? `<a href="${library.website}" target="_blank" rel="noopener" class="text-blue-600 underline">Official website</a>` : ''}
                                ${library.website ? ' ‚Ä¢ ' : ''}
                                <a href="https://www.loc.gov/" target="_blank" rel="noopener" class="text-blue-600 underline">Library of Congress catalog</a>
                            </div>
                        </div>
                    </div>

                    <!-- Embedded search bar (LoC-style) -->
                    <div class="mt-6 bg-white rounded-lg p-4 border border-gray-200">
                        <div class="flex flex-col md:flex-row gap-3">
                            <input id="libSearchInput" type="text" placeholder="Search this catalog (title or author)..." class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none" onkeypress="if(event.key==='Enter') doLibrarySearch()" />
                            <div class="flex items-center gap-3">
                                <label class="text-sm">
                                    <input type="radio" name="libSearchMode" value="title" checked /> Title
                                </label>
                                <label class="text-sm">
                                    <input type="radio" name="libSearchMode" value="author" /> Author
                                </label>
                                <button onclick="doLibrarySearch()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Search</button>
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-gray-500">Searches use the Library of Congress public books API where possible; CORS restrictions may apply ‚Äî if searches fail you can open the official LoC search link.</div>
                    </div>

                    <div class="mt-6 md:grid md:grid-cols-3 md:gap-6">
                        <div class="md:col-span-2">
                            <div id="libResults" class="space-y-4 mt-2"></div>
                        </div>
                        <div class="md:col-span-1">
                            <div class="bg-white rounded-lg p-4 border border-gray-200">
                                <h4 class="text-sm font-bold mb-2">Location</h4>
                                <div id="libMiniMapDesc" class="text-sm text-gray-600 mb-3">${coords && isFinite(coords.lat) && isFinite(coords.lng) ? `${coords.lat.toFixed(4)}, ${coords.lng.toFixed(4)}` : 'Coordinates not available'}</div>
                                <div class="w-full h-48 rounded-lg overflow-hidden border border-gray-200" id="libDetailMapMini">Map will focus here</div>
                                <div class="mt-3 text-xs text-gray-500">Use result items to view details; open official LoC records using the button on each result.</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Center the main map on the library and add a marker
            try {
                if (libraryMap) {
                    if (coords && isFinite(coords.lat) && isFinite(coords.lng)) {
                        libraryMap.setView([coords.lat, coords.lng], 14);

                        // remove previous library detail marker
                        if (libraryMap.libraryDetailMarker) {
                            try { libraryMap.removeLayer(libraryMap.libraryDetailMarker); } catch (e) {}
                        }

                        libraryMap.libraryDetailMarker = L.marker([coords.lat, coords.lng]).addTo(libraryMap);
                        // Ensure the map layout is updated and pan so the marker is centered
                        try {
                            libraryMap.invalidateSize();
                            libraryMap.panTo([coords.lat, coords.lng]);
                        } catch (e) { /* ignore pan errors */ }
                        // Use popup offset to keep marker visible and centered
                        libraryMap.libraryDetailMarker.bindPopup(`<strong>${library.name || 'Library'}</strong><br>${library.address || ''}`, { offset: [0, -10] }).openPopup();
                    } else {
                        // No valid coords: keep a neutral view but still ensure map exists
                        try { libraryMap.setView([38.8977, -77.0365], 4); } catch (e) {}
                    }
                }
            } catch (e) { console.warn('Failed to center map on library', e); }

            // Also copy the current leaflet view into the small mini map element by creating a shallow map if not present
            try {
                const miniId = 'libDetailMapMini';
                let mini = document.getElementById(miniId)._leaflet_map;
                    if (!document.getElementById(miniId)._leaflet_map) {
                        const node = document.getElementById(miniId);
                        const view = (coords && isFinite(coords.lat) && isFinite(coords.lng)) ? [coords.lat, coords.lng] : [38.8977, -77.0365];
                        const zoom = (coords && isFinite(coords.lat) && isFinite(coords.lng)) ? 14 : 4;
                        const miniMap = L.map(node, { zoomControl: false, attributionControl: false }).setView(view, zoom);
                        const tile = isDarkMode ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png' : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                        L.tileLayer(tile, { maxZoom: 19 }).addTo(miniMap);
                        if (coords && isFinite(coords.lat) && isFinite(coords.lng)) {
                            const m = L.marker([coords.lat, coords.lng]).addTo(miniMap).bindPopup(library.name || 'Library', { offset: [0, -6] });
                            try { miniMap.invalidateSize(); miniMap.panTo([coords.lat, coords.lng]); } catch (e) {}
                        }
                        // store reference so subsequent calls won't recreate
                        document.getElementById(miniId)._leaflet_map = miniMap;
                    } else {
                        // update existing mini map view only when coords are valid
                        if (coords && isFinite(coords.lat) && isFinite(coords.lng)) {
                            document.getElementById(miniId)._leaflet_map.setView([coords.lat, coords.lng], 14);
                        }
                    }
            } catch (e) { /* ignore mini map errors */ }

            // wire search button function in the page scope
            window.doLibrarySearch = async function() {
                const q = document.getElementById('libSearchInput').value || '';
                const mode = document.querySelector('input[name="libSearchMode"]:checked')?.value || 'title';
                const resultsContainer = document.getElementById('libResults');
                resultsContainer.innerHTML = `<div class="p-4 text-center text-gray-600">Searching‚Ä¶</div>`;

                if (!q.trim()) {
                    resultsContainer.innerHTML = `<div class="p-4 text-sm text-gray-600">Enter a search term (title or author).</div>`;
                    return;
                }

                const res = await performLoCSearch(q, 20, mode);
                if (!res || res.error === 'loc_cors') {
                    resultsContainer.innerHTML = `
                        <div class="p-4 text-sm text-red-600">LoC search failed (CORS or network). You can try the official LoC search:</div>
                        <div class="p-4"><a href="https://www.loc.gov/books/?q=${encodeURIComponent(q)}" target="_blank" rel="noopener" class="text-blue-600 underline">Open LoC search for ‚Äú${q}‚Äù</a></div>
                    `;
                    return;
                }

                if (!res || res.length === 0) {
                    resultsContainer.innerHTML = `<div class="p-4 text-sm text-gray-600">No results found for "${q}"</div>`;
                    return;
                }

                // Render results (author-mode shows authors; title-mode shows books)
                if (mode === 'author') {
                    resultsContainer.innerHTML = res.map(author => {
                        const locLink = `https://www.loc.gov/books/?q=${encodeURIComponent(author.name)}`;
                        return `
                            <div class="bg-white rounded-lg p-4 border border-gray-200">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 flex items-start gap-4">
                                        <div class="w-14 h-18 rounded overflow-hidden bg-gray-100 flex items-center justify-center js-cover-placeholder" data-title="${author.name}" data-author="${author.name}">
                                            ${author.coverUrl ? `<img src="${author.coverUrl}" alt="${author.name} cover" class="cover-thumb">` : '<div class="text-xl">‚úçÔ∏è</div>'}
                                        </div>
                                        <div>
                                            <div class="font-semibold">${author.name}</div>
                                            ${author.topWork ? `<div class="text-sm text-gray-600">Sample work: ${author.topWork}</div>` : ''}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="flex flex-col items-end gap-2">
                                            <a href="${locLink}" target="_blank" rel="noopener" class="inline-flex items-center px-3 py-1.5 border border-blue-600 text-blue-600 rounded text-sm hover:bg-blue-50" aria-label="Search Library of Congress for author ${author.name}">
                                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9-7-9-7-9 7 9 7z"></path></svg>
                                                Check in Library
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    // Try to enrich missing covers in the background
                    setTimeout(() => enrichMissingCovers(12), 100);
                } else {
                    resultsContainer.innerHTML = res.map(item => {
                        const locLink = (item.id && item.id.startsWith('http')) ? item.id : (`https://www.loc.gov/books/?q=${encodeURIComponent(item.title)}`);
                        const call = item.physicalCopies && item.physicalCopies[0] ? item.physicalCopies[0].callNumber : null;
                        return `
                            <div class="bg-white rounded-lg p-4 border border-gray-200">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 flex items-start gap-4">
                                        <div class="w-14 h-18 rounded overflow-hidden bg-gray-100 flex items-center justify-center js-cover-placeholder" data-title="${item.title}" data-author="${item.author || ''}">
                                            ${item.coverUrl ? `<img src="${item.coverUrl}" alt="${item.title} cover" class="cover-thumb">` : '<div class="text-xl">üìñ</div>'}
                                        </div>
                                        <div>
                                            <div class="font-semibold">${item.title}</div>
                                            <div class="text-sm text-gray-600">${item.author || ''}${call ? ' ‚Ä¢ Call: ' + call : ''}</div>
                                            ${item.description ? `<div class="mt-2 text-sm text-gray-700">${item.description}</div>` : ''}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="flex flex-col items-end gap-2">
                                            <a href="${locLink}" target="_blank" rel="noopener" class="inline-flex items-center px-3 py-1.5 border border-blue-600 text-blue-600 rounded text-sm hover:bg-blue-50" aria-label="Check this item in the library catalog for ${item.title}">
                                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9-7-9-7-9 7 9 7z"></path></svg>
                                                Check in Library
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    // Try to enrich missing covers in the background
                    setTimeout(() => enrichMissingCovers(12), 100);
                }
            };

            // helper exposed to page to show an individual result on the map
            window.showLibraryResultOnMap = function(item) {
                try {
                    clearBookMarkers();
                    const phys = (item.physicalCopies || []).map(p => {
                        if (!p || !p.coordinates) return null;
                        const lat = Number(p.coordinates.lat);
                        const lng = Number(p.coordinates.lng);
                        if (!isFinite(lat) || !isFinite(lng)) return null;
                        return { lat, lng, libraryName: p.libraryName || 'Library', address: p.address || '', callNumber: p.callNumber || null, available: p.available };
                    }).filter(Boolean);

                    if (phys.length === 0) {
                        alert('No physical location data available for this item.');
                        return;
                    }

                    addBookLocationMarkers(phys);
                } catch (e) {
                    console.error('showLibraryResultOnMap error', e);
                }
            };
        }

        function closeModal() {
            document.getElementById('bookModal').classList.add('hidden');
        }

        // ===========================================
        // FILTER FUNCTIONS
        // ===========================================
        
    // Advanced filters removed - simplified search bar

        function quickSearch(genre) {
            document.getElementById('mainSearch').value = genre;
            // default quick searches to digital title searches
            const titleRadio = document.querySelector('input[name="searchMode"][value="title"]');
            const digitalRadio = document.querySelector('input[name="searchSource"][value="digital"]');
            if (titleRadio) titleRadio.checked = true;
            if (digitalRadio) digitalRadio.checked = true;
            showSearchResults();
        }

        // ===========================================
        // SEARCH FUNCTIONS
        // ===========================================
        
        async function performSearch(query) {
            if (!query || query.length < 2) {
                searchResults = [];
                return;
            }
            // Kept minimal: actual calls happen in showSearchResults via searchBooks
        }

        // Minimal unified search implementation using Open Library (demo-like)
        async function searchBooksUnified(query, filters = {}) {
            const mode = (filters.mode || filters.searchMode || 'title').toLowerCase();
            const digital = !!filters.digital || filters.source === 'digital';
            const isCatalog = (filters.source === 'catalog' || filters.source === 'loc');

            try {
                // If user requested library catalog mode, use LoC search
                if (isCatalog) {
                    if (mode === 'author') {
                        const authors = await performLoCSearch(query, 12, 'author');
                        // LoC returns book-like results; map them as authors if needed
                        return authors.map(a => ({ type: 'author', item: a }));
                    }

                    // catalog/title search
                    const locBooks = await performLoCSearch(query, 12, 'title');
                    return locBooks.map(b => ({ type: 'book', item: b }));
                }

                if (mode === 'author') {
                    const authors = await performAuthorSearch(query);
                    return authors.map(a => ({ type: 'author', item: a }));
                }

                // default: title search (digital/OpenLibrary)
                const books = await performTitleSearch(query, { digital });
                return books.map(b => ({ type: 'book', item: b }));
            } catch (err) {
                console.error('searchBooksUnified failed', err);
                return [];
            }
        }

        // Use Open Library authors API to find authors
        async function performAuthorSearch(query) {
            if (!query) return [];
            try {
                const url = `https://openlibrary.org/search/authors.json?q=${encodeURIComponent(query)}`;
                const res = await fetch(url);
                if (!res.ok) return [];
                const data = await res.json();
                const docs = data.docs || [];
                return docs.slice(0, 12).map(d => ({
                    id: d.key || d.name,
                    name: d.name || '',
                    birthYear: d.birth_date || null,
                    topWork: d.top_work || null,
                    workCount: d.work_count || 0
                }));
            } catch (e) {
                console.error('performAuthorSearch error', e);
                return [];
            }
        }

        // Use Open Library title search and map minimal fields; for catalog searches, attach LoC physical marker when LCCN exists
        async function performTitleSearch(query, opts = {}) {
            if (!query) return [];
            const digitalOnly = !!opts.digital;
            try {
                const url = `https://openlibrary.org/search.json?title=${encodeURIComponent(query)}&limit=12`;
                const res = await fetch(url);
                if (!res.ok) return [];
                const data = await res.json();
                const docs = data.docs || [];

                return docs.map(d => {
                    const title = d.title || d.title_suggest || 'Untitled';
                    const author = (d.author_name && d.author_name[0]) || (d.author && d.author[0]) || '';
                    const isbn = d.isbn && d.isbn[0];
                    const lccn = d.lccn && d.lccn[0];
                    const iaId = d.ia && d.ia[0];
                    const coverId = d.cover_i || null;
                    const coverUrl = coverId ? `https://covers.openlibrary.org/b/id/${coverId}-M.jpg` : (iaId ? `https://archive.org/services/img/${iaId}` : '');

                    const item = {
                        id: d.key || (isbn ? `ISBN:${isbn}` : title),
                        title: title,
                        author: author,
                        coverId: coverId,
                        coverUrl: coverUrl,
                        description: d.first_sentence || d.subtitle || '',
                        digitalAvailable: !!iaId || !!d.ebook_access || false,
                        libraryCount: lccn ? 1 : 0,
                        physicalCopies: []
                    };

                    // If not digital-only and we have an LCCN, map to Library of Congress coordinates (best-effort)
                    if (!digitalOnly && lccn) {
                        item.physicalCopies.push({
                            libraryId: 'loc',
                            libraryName: 'Library of Congress',
                            available: true,
                            callNumber: d.callnumber ? d.callnumber[0] : null,
                            address: '101 Independence Ave SE, Washington, DC',
                            coordinates: { lat: 38.8886, lng: -77.0047 }
                        });
                    }

                    return item;
                }).slice(0, 12);
            } catch (e) {
                console.error('performTitleSearch error', e);
                return [];
            }
        }

        // ===========================================
        // Library of Congress search (catalog mode)
        // ===========================================
        // Derive a best-effort cover URL from a LoC record using available identifiers
        function getCoverUrlFromLocRecord(r) {
            try {
                if (!r || typeof r !== 'object') return '';
                // Prefer ISBN via OpenLibrary covers
                if (r.isbn && Array.isArray(r.isbn) && r.isbn[0]) {
                    const isbn = String(r.isbn[0]).replace(/[^0-9Xx-]/g, '');
                    if (isbn) return `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(isbn)}-M.jpg`;
                }

                // Internet Archive identifiers
                if (r.ocaid) {
                    return `https://archive.org/services/img/${encodeURIComponent(r.ocaid)}`;
                }
                if (r.identifier && typeof r.identifier === 'string') {
                    // some records have identifier strings that may be IA ids
                    return `https://archive.org/services/img/${encodeURIComponent(r.identifier)}`;
                }

                // fallback: try LCCN or other keys (not a reliable cover source)
                return '';
            } catch (e) {
                return '';
            }
        }
        async function performLoCSearch(query, limit = 12, mode = 'title') {
            if (!query) return [];
            try {
                const q = mode === 'author' ? `creator:${query}` : query;
                const url = `https://www.loc.gov/books/?q=${encodeURIComponent(q)}&fo=json&c=${limit}`;
                const res = await fetch(url);
                if (!res.ok) {
                    console.warn('LoC responded with', res.status);
                    return [];
                }
                const data = await res.json();
                const results = data.results || [];

                // If caller asked for authors, aggregate and return unique author entries
                if (mode === 'author') {
                    const authorsSet = new Map();
                    results.forEach(r => {
                        let creators = [];
                        if (r.creator) creators = Array.isArray(r.creator) ? r.creator : [r.creator];
                        else if (r.contributor) creators = Array.isArray(r.contributor) ? r.contributor : [r.contributor];

                        creators.forEach(name => {
                            if (!name) return;
                            const key = String(name).trim();
                            if (!key) return;
                            if (!authorsSet.has(key)) {
                                authorsSet.set(key, {
                                    id: `loc-author:${encodeURIComponent(key)}`,
                                    name: key,
                                    topWork: r.title || '',
                                    workSample: r,
                                    coverUrl: getCoverUrlFromLocRecord(r)
                                });
                            }
                        });
                    });

                    return Array.from(authorsSet.values()).slice(0, limit);
                }

        // Default: return book-like items (attach coverUrl when possible)
        return results.map(r => {
                    const title = r.title || '';
                    const authors = r.creator || r.contributor || (r.contributors && r.contributors.join(', ')) || '';
                    const description = r.description || r.notes || '';
                    const isbn = (r.isbn && r.isbn[0]) || null;
                    const lccn = r.lccn || null;
                    const id = r.id || (lccn ? `loc:${lccn}` : (isbn ? `ISBN:${isbn}` : `loc:${encodeURIComponent(title)}`));

                    const item = {
                        id,
                        title,
            author: Array.isArray(authors) ? authors.join(', ') : authors,
                        description,
                        identifiers: { isbn, lccn },
                        digitalAvailable: false,
            coverUrl: getCoverUrlFromLocRecord(r) || '',
                        libraryCount: 1,
                        physicalCopies: [
                            {
                                libraryId: 'loc',
                                libraryName: 'Library of Congress',
                                available: true,
                                callNumber: r.call_number ? (Array.isArray(r.call_number) ? r.call_number[0] : r.call_number) : null,
                                address: '101 Independence Ave SE, Washington, DC',
                                coordinates: { lat: 38.8886, lng: -77.0047 }
                            }
                        ]
                    };

                    return item;
                });
            } catch (err) {
                console.warn('performLoCSearch failed (possible CORS):', err);
                return { error: 'loc_cors' };
            }
        }

        // Query Open Library search to try to find a cover by title+author (best-effort)
        async function fetchOpenLibraryCoverByTitleAuthor(title, author) {
            try {
                if (!title) return '';
                const q = `title:${title}` + (author ? `+author:${author}` : '');
                const url = `https://openlibrary.org/search.json?${new URLSearchParams({ title: title, author: author || '', limit: 1 }).toString()}`;
                const res = await fetch(url);
                if (!res.ok) return '';
                const data = await res.json();
                const doc = (data.docs && data.docs[0]) || null;
                if (!doc) return '';
                const coverId = doc.cover_i || null;
                if (coverId) return `https://covers.openlibrary.org/b/id/${coverId}-M.jpg`;
                const iaId = doc.ia && doc.ia[0];
                if (iaId) return `https://archive.org/services/img/${iaId}`;
                // try isbn
                const isbn = doc.isbn && doc.isbn[0];
                if (isbn) return `https://covers.openlibrary.org/b/isbn/${isbn}-M.jpg`;
                return '';
            } catch (e) { return ''; }
        }

        // After rendering results, find placeholders and try to enrich them with Open Library covers
        async function enrichMissingCovers(limit = 8) {
            const placeholders = Array.from(document.querySelectorAll('.js-cover-placeholder')).slice(0, limit);
            for (const ph of placeholders) {
                try {
                    const title = ph.getAttribute('data-title') || '';
                    const author = ph.getAttribute('data-author') || '';
                    const candidate = await fetchOpenLibraryCoverByTitleAuthor(title, author);
                    if (candidate) {
                        const img = document.createElement('img');
                        img.src = candidate;
                        img.className = 'cover-thumb';
                        img.alt = `${title} cover`;
                        ph.innerHTML = '';
                        ph.appendChild(img);
                        // remove placeholder marker so we don't re-query
                        ph.classList.remove('js-cover-placeholder');
                    }
                } catch (e) { /* ignore per-item errors */ }
            }
        }

        // ===========================================
        // THEME FUNCTIONS
        // ===========================================
        
        let isDarkMode = false;
        
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            
            if (isDarkMode) {
                body.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');

                // Switch to dark tiles if the map exists
                try {
                    if (libraryMap && libraryMap.baseTileLayer) {
                        libraryMap.removeLayer(libraryMap.baseTileLayer);
                        libraryMap.baseTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                            attribution: '&copy; OpenStreetMap, &copy; CARTO'
                        }).addTo(libraryMap);
                    }
                } catch (e) { console.warn('Failed to switch map to dark tiles', e); }
            } else {
                body.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');

                // Restore light tiles
                try {
                    if (libraryMap && libraryMap.baseTileLayer) {
                        libraryMap.removeLayer(libraryMap.baseTileLayer);
                        libraryMap.baseTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                            attribution: '&copy; OpenStreetMap contributors'
                        }).addTo(libraryMap);
                    }
                } catch (e) { console.warn('Failed to restore map light tiles', e); }
            }

            localStorage.setItem('darkMode', isDarkMode);
        }
        
        function initializeTheme() {
            const savedTheme = localStorage.getItem('darkMode');
            if (savedTheme === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark');
                document.getElementById('sunIcon').classList.add('hidden');
                document.getElementById('moonIcon').classList.remove('hidden');
            }
        }

        // ===========================================
        // LEAFLET MAP: Initialization and Helpers
        // ===========================================

        // Map state
        let libraryMap = null;
        let mapMarkers = [];
        let bookMarkersLayer = null;
        let currentApiSource = 'loc';

        // Initialize the Leaflet map and add base markers
        function initializeMap() {
            const container = document.getElementById('libraryMap');
            if (!container) return;
            if (libraryMap) return; // already initialized

            // Create map centered on a neutral view (continental US) ‚Äî adjust as needed
            libraryMap = L.map(container).setView([38.8977, -77.0365], 4);

            // Create a base tile layer that we can swap when dark mode toggles
            const lightTile = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            const darkTile = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png';
            const chosen = isDarkMode ? darkTile : lightTile;
            libraryMap.baseTileLayer = L.tileLayer(chosen, {
                maxZoom: 19,
                attribution: isDarkMode ? '&copy; OpenStreetMap, &copy; CARTO' : '&copy; OpenStreetMap contributors'
            }).addTo(libraryMap);

            // Add known library/service markers (LoC is available physically in this prototype)
            addLibraryMarkers();
        }

        function addLibraryMarkers() {
            if (!libraryMap) return;

            // Example: Library of Congress marker (approximate coordinates)
            try {
                const loc = L.circleMarker([38.8886, -77.0047], {
                    radius: 8,
                    color: '#2563eb',
                    fillColor: '#2563eb',
                    fillOpacity: 0.9
                }).addTo(libraryMap);
                loc.bindPopup('<strong>Library of Congress</strong><br>Physical collections available');
            } catch (e) {
                console.warn('Failed to add base library markers', e);
            }
        }

        // Remove book-specific markers
        function clearBookMarkers() {
            if (bookMarkersLayer) {
                bookMarkersLayer.clearLayers();
            }
            mapMarkers = [];
        }

        // Add markers for specific book physical locations
        function addBookLocationMarkers(locations) {
            if (!libraryMap || !locations || locations.length === 0) return;

            if (!bookMarkersLayer) {
                bookMarkersLayer = L.layerGroup().addTo(libraryMap);
            }

            locations.forEach(loc => {
                try {
                    const marker = L.marker([loc.lat, loc.lng]).addTo(bookMarkersLayer);
                    const popupHtml = `
                        <div style="font-size:14px">
                            <strong>${loc.libraryName || 'Library'}</strong><br>
                            ${loc.address || ''}<br>
                            ${loc.callNumber ? 'Call: ' + loc.callNumber + '<br>' : ''}
                            ${typeof loc.available !== 'undefined' ? ('Available: ' + (loc.available ? 'Yes' : 'No')) : ''}
                        </div>
                    `;
                    marker.bindPopup(popupHtml);
                    mapMarkers.push(marker);
                } catch (e) {
                    console.warn('Failed to add book marker', e);
                }
            });

            // Fit map to markers if possible
            try {
                const bounds = bookMarkersLayer.getBounds();
                if (bounds.isValid()) {
                    libraryMap.fitBounds(bounds, { maxZoom: 14, padding: [40, 40] });
                }
            } catch (e) {
                // ignore
            }
        }

        function onApiSourceChange() {
            const sel = document.getElementById('apiSourceSelect');
            if (!sel) return;
            currentApiSource = sel.value;
            // Future: toggle UI elements based on source capabilities
        }


        // ===========================================
        // INITIALIZATION
        // ===========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            showSearchInterface();
            
            // Initialize Leaflet map
            setTimeout(() => {
                initializeMap();
            }, 100); // Small delay to ensure DOM is ready
            
            // Close modal when clicking outside
            document.getElementById('bookModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        });

        // ===========================================
        // DATABASE INTEGRATION GUIDE
        // ===========================================
        
        /*
        TO INTEGRATE WITH YOUR DATABASE:
        
        1. Update API_CONFIG at the top of this file:
           - Set your API base URL
           - Configure your endpoints
           - Add your API key if needed
        
        2. Your API should return data in this format:
        
        BOOKS:
        {
            "data": [
                {
                    "id": "unique-book-id",
                    "title": "Book Title",
                    "author": "Author Name",
                    "isbn": "978-1234567890",
                    "genre": "Fiction",
                    "subgenre": "Mystery",
                    "publishYear": 2023,
                    "publisher": "Publisher Name",
                    "pages": 300,
                    "language": "English",
                    "rating": 4.5,
                    "votes": 1234,
                    "description": "Book description...",
                    "summary": "Book summary...",
                    "digitalAvailable": true,
                    "libraryCount": 5,
                    "downloadCount": 1000,
                    "keywords": ["keyword1", "keyword2"],
                    "subjects": ["Subject1", "Subject2"],
                    "awards": ["Award Name"],
                    "physicalCopies": [
                        {
                            "libraryId": "library-id",
                            "available": true,
                            "callNumber": "123.45 ABC",
                            "floor": "2nd Floor",
                            "section": "Fiction"
                        }
                    ],
                    "digitalCopies": {
                        "available": true,
                        "format": ["PDF", "EPUB"],
                        "fileSize": "2.4 MB",
                        "downloadCount": 1000,
                        "platforms": ["Kindle", "Apple Books"]
                    }
                }
            ]
        }
        
        AUTHORS:
        {
            "data": [
                {
                    "id": "unique-author-id",
                    "name": "Author Name",
                    "birthYear": 1970,
                    "deathYear": null,
                    "nationality": "American",
                    "biography": "Author biography...",
                    "totalBooks": 5,
                    "genres": ["Fiction", "Mystery"],
                    "awards": ["Award Name"],
                    "website": "author-website.com"
                }
            ]
        }
        
        LIBRARIES:
        {
            "data": [
                {
                    "id": "unique-library-id",
                    "name": "Library Name",
                    "city": "City",
                    "country": "Country",
                    "established": 1900,
                    "totalBooks": 1000000,
                    "digitalAccess": true,
                    "physicalAccess": true,
                    "address": "Full address...",
                    "website": "library-website.com",
                    "contact": "+1-234-567-8900",
                    "bookCount": 150,
                    "availableBooks": 120
                }
            ]
        }
        
        3. Implement these API endpoints:
           - GET /api/search?q=query&availability=all&language=all&genre=all&year=all
           - GET /api/books?digital=true (for digital collection)
           - GET /api/books/:id
           - GET /api/authors
           - GET /api/authors/:id
           - GET /api/libraries
           - GET /api/libraries/:id
           
        
        4. The frontend will automatically:
           - Show loading states during API calls
           - Handle errors gracefully
           - Display "No results found" when appropriate
           - Maintain navigation and breadcrumbs
        
        5. Customize the rendering functions if your data structure differs
        */
</script>
</body>
</html>
</html>
